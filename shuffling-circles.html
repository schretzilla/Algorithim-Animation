<!doctype html>
<html>

<head>
		<title>D3 Test</title>
		<script src="d3.v4.js"></script>
</head>

<body>
  <script>
    //global vars
    let startYCord = 100;
    let startXCord = 50;
    let startRadius = 25;
    let moveDuration = 1500;
    let circleList = [];
    //build canvas
    var canvas = d3.select("body")
            .append("svg")
            .attr("width", 1000)
            .attr("height", 500);

    //drawl 2 circles
    // TODO: Add text with value for circle (or do radius size)

    for(let i=0; i<10; i++){
      let circleEle = createCircleEle(i);
      circleList.push(circleEle);
    }

    //Generate the weights array then pass it to the workers
    let weightsArray = generateRandomArrayWeights();
    console.log(weightsArray);
    getInsertionSortMoves(weightsArray);
    getBubbleSortMoves(weightsArray);

    animationLoop(circleList[0], circleList[2], 0);

    //Creates a circle element in a line along the designated x axis
    function createCircleEle(eleStartIndex){
      let circleEle = canvas.append("circle")
                        .attr("cx", startXCord + (eleStartIndex*2*startRadius))
                        .attr("cy", startYCord)
                        .attr("r", startRadius)
                        .attr("fill", getRandomColor);

      return circleEle;
    }

    //Adds random fill color to an svg attribute
    function getRandomColor(){
      return "hsl(" + Math.random() * 360 + ",100%,50%)"
    }

    //swapIndex, ending function for the recurrsion
    function animationLoop(circle1, circle2, swapIndex){
      let animationTimeDuration = swapPlaces(circle1, circle2, 0);

      if(swapIndex < 6){
        setTimeout(function(){
          console.log('swap #' + swapIndex);
          circle1Index = Math.floor(Math.random() * circleList.length);
          do{
            circle2Index = Math.floor(Math.random() * circleList.length);
          } 
          while(circle2Index==circle1Index);
          console.log('swapping ' + circle1Index + ' with ' + circle2Index);
          animationLoop(circleList[circle1Index], circleList[circle2Index], swapIndex+1);
        }, animationTimeDuration);
      }
      
    }

    function swapPlaces(circle1, circle2){
      console.log("swap called");
      // The displaced y position where cirlce1's swaps will occure
      let stagingYCord1 = 150;
      // The displaced y position where circle2's swaps will occure
      let stagingYCord2 = 150 + (2*startRadius);

      //Move one circle up one full circle radius
      circle1.transition()
          .duration(moveDuration)   //measured in Mili Seconds
          .attr("cy", stagingYCord1);

      //Move the other circle up 2 full radius
      circle2.transition()
          .duration(moveDuration)
          .attr("cy", stagingYCord2);
      
      //Swap circles' x positions
      circle1.transition()
        .delay(moveDuration)
        .duration(moveDuration)
        .attr("cx", circle2.attr("cx"));

      circle2.transition()
        .delay(moveDuration)
        .duration(moveDuration)
        .attr("cx", circle1.attr("cx"));

      //Move back to original line
      circle1.transition()
        .delay(2*moveDuration)
        .duration(moveDuration)
        .attr("cy", startYCord);

      circle2.transition()
        .delay(2*moveDuration)
        .duration(moveDuration)
        .attr("cy", startYCord);

      return 3*moveDuration;
    }

    function generateRandomArrayWeights(){
      //Generate random array of ints between 1-20
      let weightsArray = [];
      for(let i=0; i<10; i++){
        let newNum = Math.floor(Math.random() * 20);
        
        weightsArray.push(newNum);
      }

      return weightsArray;
    }

    //return a list of all swap pairs needed for the list to become sorted
    // TODO: this might be insertion sort
    function getInsertionSortMoves(weightsArray){
      //Records the pairs of indexs that are swapped
      let movesArray = [];

      // TODO: handle this off by 1 weirdness
      for(let i=0; i<weightsArray.length-1; i++){
        let curNum = weightsArray[i];
        for(let j=i+1; j<weightsArray.length; j++){
          let nextNum = weightsArray[j];
          //Test if next number is smaller than current number
          if(nextNum < curNum ){
            //swap
            weightsArray[i] = nextNum;
            weightsArray[j] = curNum;
            
            //update the cur number 
            curNum = nextNum;

            //Record the swapped positions
            let swappedIndices = [i, j];
            movesArray.push(swappedIndices);
          }
        }
      }

      console.log(weightsArray);
      console.log(movesArray);
      return movesArray;
    }

    function getBubbleSortMoves(weightsArray){
      for(let i=0; i<weightsArray.length; i++){
        let curNum = weightsArray[i];
        // for
      }
    }

  </script>

</body>

</html>